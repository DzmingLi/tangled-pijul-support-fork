when:
  - event: ["push", "pull_request"]
    branch: master

engine: nixery

dependencies:
  nixpkgs:
    - go
    - gcc

steps:
  - name: patch static dir
    command: |
      mkdir -p appview/pages/static; touch appview/pages/static/x

  - name: run go mod tidy
    command: go mod tidy

  - name: run gomod2nix
    command: |
      HOME=$(mktemp -d)
      echo $HOME
      nix run .#gomod2nix

  - name: verify no changes
    command: |
      if ! git diff --quiet; then
        echo "Error: gomod2nix produced changes. Please commit the updated files."
        git diff
        exit 1
      fi

  - name: run linter
    environment:
      CGO_ENABLED: 1
    command: |
      go vet -v ./...

  - name: run all tests
    environment:
      CGO_ENABLED: 1
    command: |
      go test -v ./...
